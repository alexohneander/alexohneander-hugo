<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Site to Site VPN for Google Kubernetes Engine | Alexohneander</title><meta name=keywords content="kubernetes,openvpn,google"><meta name=description content="In this tutorial I will try to explain you briefly and concisely how you can set up a site-to-site VPN for the Google Cloud Network.
Prerequisites We need 2 virtual machines. The first one on the side of our office and the other one on the side of Google.
Setup OpenVPN Clients Site-to-Site Client Office Side We need to install OpenVPN, we do it as follows:
apt install openvpn -y After that we add our OpenVPN configuration under this path /etc/openvpn/s2s."><meta name=author content="Alex Wellnitz"><link rel=canonical href=https://alexohneander.de/posts/site-to-site-vpn-for-google-kubernetes-engine/><link crossorigin=anonymous href=/assets/css/stylesheet.min.47a664ae3e3ed734362e8d9248ffbc8328600b7928426bf7cef80e1836c24e84.css integrity="sha256-R6Zkrj4+1zQ2Lo2SSP+8gyhgC3koQmv3zvgOGDbCToQ=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://alexohneander.de/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://alexohneander.de/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://alexohneander.de/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://alexohneander.de/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://alexohneander.de/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Site to Site VPN for Google Kubernetes Engine"><meta property="og:description" content="In this tutorial I will try to explain you briefly and concisely how you can set up a site-to-site VPN for the Google Cloud Network.
Prerequisites We need 2 virtual machines. The first one on the side of our office and the other one on the side of Google.
Setup OpenVPN Clients Site-to-Site Client Office Side We need to install OpenVPN, we do it as follows:
apt install openvpn -y After that we add our OpenVPN configuration under this path /etc/openvpn/s2s."><meta property="og:type" content="article"><meta property="og:url" content="https://alexohneander.de/posts/site-to-site-vpn-for-google-kubernetes-engine/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-06T19:20:27+02:00"><meta property="article:modified_time" content="2021-05-06T19:20:27+02:00"><meta property="og:site_name" content="Alexohneander"><meta name=twitter:card content="summary"><meta name=twitter:title content="Site to Site VPN for Google Kubernetes Engine"><meta name=twitter:description content="In this tutorial I will try to explain you briefly and concisely how you can set up a site-to-site VPN for the Google Cloud Network.
Prerequisites We need 2 virtual machines. The first one on the side of our office and the other one on the side of Google.
Setup OpenVPN Clients Site-to-Site Client Office Side We need to install OpenVPN, we do it as follows:
apt install openvpn -y After that we add our OpenVPN configuration under this path /etc/openvpn/s2s."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://alexohneander.de/posts/"},{"@type":"ListItem","position":3,"name":"Site to Site VPN for Google Kubernetes Engine","item":"https://alexohneander.de/posts/site-to-site-vpn-for-google-kubernetes-engine/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Site to Site VPN for Google Kubernetes Engine","name":"Site to Site VPN for Google Kubernetes Engine","description":"In this tutorial I will try to explain you briefly and concisely how you can set up a site-to-site VPN for the Google Cloud Network.\nPrerequisites We need 2 virtual machines. The first one on the side of our office and the other one on the side of Google.\nSetup OpenVPN Clients Site-to-Site Client Office Side We need to install OpenVPN, we do it as follows:\napt install openvpn -y After that we add our OpenVPN configuration under this path /etc/openvpn/s2s.","keywords":["kubernetes","openvpn","google"],"articleBody":"In this tutorial I will try to explain you briefly and concisely how you can set up a site-to-site VPN for the Google Cloud Network.\nPrerequisites We need 2 virtual machines. The first one on the side of our office and the other one on the side of Google.\nSetup OpenVPN Clients Site-to-Site Client Office Side We need to install OpenVPN, we do it as follows:\napt install openvpn -y After that we add our OpenVPN configuration under this path /etc/openvpn/s2s.conf.\ns2s.conf\n# Use a dynamic tun device. # For Linux 2.2 or non-Linux OSes, # you may want to use an explicit # unit number such as \"tun1\". # OpenVPN also supports virtual # ethernet \"tap\" devices. dev tun # Our OpenVPN peer is the Google gateway. remote IP_GOOGLE_VPN_CLIENT ifconfig 4.1.0.2 4.1.0.1 route 10.156.0.0 255.255.240.0 # Google Cloud VM Network route 10.24.0.0 255.252.0.0 # Google Kubernetes Pod Network push \"route 192.168.10.0 255.255.255.0\" # Office Network # Our pre-shared static key #secret static.key # Cipher to use cipher AES-256-CBC port 1195 user nobody group nogroup # Uncomment this section for a more reliable detection when a system # loses its connection. For example, dial-ups or laptops that # travel to other locations. ping 15 ping-restart 45 ping-timer-rem persist-tun persist-key # Verbosity level. # 0 -- quiet except for fatal errors. # 1 -- mostly quiet, but display non-fatal network errors. # 3 -- medium output, good for normal operation. # 9 -- verbose, good for troubleshooting verb 3 log /etc/openvpn/s2s.log We also have to enable the IPv4 forward function in the kernel, so we go to /etc/sysctl.conf and comment out the following line:\nnet.ipv4.ip_forward=1 We can then start our OpenVPN client with this command:\nsystemctl start openvpn@s2s On the Office side we have to open the port for the OpenVPN client that the other side can connect.\nSite-to-Site Client Google Side When setting up the OpenVPN client on Google’s site, we need to consider the following settings when creating it. When we create the machine, we need to enable this option in the network settings:\nAlso on this side we have to install the OpenVPN client again and then add this config under the path /etc/openvpn/s2s.conf:\n# Use a dynamic tun device. # For Linux 2.2 or non-Linux OSes, # you may want to use an explicit # unit number such as \"tun1\". # OpenVPN also supports virtual # ethernet \"tap\" devices. dev tun # Our OpenVPN peer is the Office gateway. remote IP_OFFICE_VPN_CLIENT ifconfig 4.1.0.2 4.1.0.1 route 192.168.10.0 255.255.255.0 # Office Network push \"route 10.156.0.0 255.255.240.0\" # Google Cloud VM Network push \"route 10.24.0.0 255.252.0.0\" # Google Kubernetes Pod Network # Our pre-shared static key #secret static.key # Cipher to use cipher AES-256-CBC port 1195 user nobody group nogroup # Uncomment this section for a more reliable detection when a system # loses its connection. For example, dial-ups or laptops that # travel to other locations. ping 15 ping-restart 45 ping-timer-rem persist-tun persist-key # Verbosity level. # 0 -- quiet except for fatal errors. # 1 -- mostly quiet, but display non-fatal network errors. # 3 -- medium output, good for normal operation. # 9 -- verbose, good for troubleshooting verb 3 log /etc/openvpn/s2s.log We also have to enable the IPv4 forward function in the kernel, so we go to /etc/sysctl.conf and comment out the following line:\nnet.ipv4.ip_forward=1 Connection test Now that both clients are basically configured we can test the connection. Both clients have to be started with systemctl. After that we look at the logs with tail -f /etc/openvpn/s2s-log and wait for this message:\nWed May 5 08:28:01 2021 /sbin/ip route add 10.28.0.0/20 via 4.1.0.1 Wed May 5 08:28:01 2021 TCP/UDP: Preserving recently used remote address: [AF_INET]0.0.0.0:1195 Wed May 5 08:28:01 2021 Socket Buffers: R=[212992-\u003e212992] S=[212992-\u003e212992] Wed May 5 08:28:01 2021 UDP link local (bound): [AF_INET][undef]:1195 Wed May 5 08:28:01 2021 UDP link remote: [AF_INET]0.0.0.0:1195 Wed May 5 08:28:01 2021 GID set to nogroup Wed May 5 08:28:01 2021 UID set to nobody Wed May 5 08:28:11 2021 Peer Connection Initiated with [AF_INET]0.0.0.0:1195 Wed May 5 08:28:12 2021 WARNING: this configuration may cache passwords in memory -- use the auth-nocache option to prevent this Wed May 5 08:28:12 2021 Initialization Sequence Completed If we can’t establish a connection, we need to check if the ports are opened on both sides.\nRouting Google Cloud Network After our clients have finished installing and configuring, we need to set the routes on Google. I will not map the Office side, as this is always different. But you have to route the networks for the Google network there as well.\nTo set the route on Google we go to the network settings and then to Routes. Here you have to specify your office network so that the clients in the Google network know what to do.\nIP-Masquerade-Agent IP masquerading is a form of network address translation (NAT) used to perform many-to-one IP address translations, which allows multiple clients to access a destination using a single IP address. A GKE cluster uses IP masquerading so that destinations outside of the cluster only receive packets from node IP addresses instead of Pod IP addresses. This is useful in environments that expect to only receive packets from node IP addresses.\nYou have to edit the ip-masq-agent and this configuration is responsible for letting the pods inside the nodes, reach other parts of the GCP VPC Network, more specifically the VPN. So, it allows pods to communicate with the devices that are accessible through the VPN.\nFirst of all we’re gonna be working inside the kube-system namespace, and we’re gonna put the configmap that configures our ip-masq-agent, put this in a config file:\nnonMasqueradeCIDRs: - 10.24.0.0/14 # The IPv4 CIDR the cluster is using for Pods (required) - 10.156.0.0/20 # The IPv4 CIDR of the subnetwork the cluster is using for Nodes (optional, works without but I guess its better with it) masqLinkLocal: false resyncInterval: 60s and run kubectl create configmap ip-masq-agent --from-file config --namespace kube-system\nafterwards, configure the ip-masq-agent, put this in a ip-masq-agent.yml file:\napiVersion: extensions/v1beta1 kind: DaemonSet metadata: name: ip-masq-agent namespace: kube-system spec: template: metadata: labels: k8s-app: ip-masq-agent spec: hostNetwork: true containers: - name: ip-masq-agent image: gcr.io/google-containers/ip-masq-agent-amd64:v2.4.1 args: - --masq-chain=IP-MASQ # To non-masquerade reserved IP ranges by default, uncomment the line below. # - --nomasq-all-reserved-ranges securityContext: privileged: true volumeMounts: - name: config mountPath: /etc/config volumes: - name: config configMap: # Note this ConfigMap must be created in the same namespace as the daemon pods - this spec uses kube-system name: ip-masq-agent optional: true items: # The daemon looks for its config in a YAML file at /etc/config/ip-masq-agent - key: config path: ip-masq-agent tolerations: - effect: NoSchedule operator: Exists - effect: NoExecute operator: Exists - key: \"CriticalAddonsOnly\" operator: \"Exists\" and run kubectl -n kube-system apply -f ip-masq-agent.yml.\nNow our site-to-site VPN should be set up. You should now test if you can ping the pods and if all other services work as you expect them to.\n","wordCount":"1163","inLanguage":"en","datePublished":"2021-05-06T19:20:27+02:00","dateModified":"2021-05-06T19:20:27+02:00","author":{"@type":"Person","name":"Alex Wellnitz"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://alexohneander.de/posts/site-to-site-vpn-for-google-kubernetes-engine/"},"publisher":{"@type":"Organization","name":"Alexohneander","logo":{"@type":"ImageObject","url":"https://alexohneander.de/%3Clink%20/%20abs%20url%3E"}}}</script><script defer data-domain=alexohneander.de src=https://analytics.wellcom.rocks/js/script.js></script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://alexohneander.de accesskey=h title="Alexohneander (Alt + H)">Alexohneander</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://alexohneander.de/ title="Über Mich"><span>Über Mich</span></a></li><li><a href=https://alexohneander.de/experience/ title=Erfahrung><span>Erfahrung</span></a></li><li><a href=https://alexohneander.de/search/ title="Suche (Alt + /)" accesskey=/><span>Suche</span></a></li><li><a href=https://alexohneander.de/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://alexohneander.de>Home</a>&nbsp;»&nbsp;<a href=https://alexohneander.de/posts/>Posts</a></div><h1 class=post-title>Site to Site VPN for Google Kubernetes Engine</h1><div class=post-meta><span title='2021-05-06 19:20:27 +0200 +0200'>May 6, 2021</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Alex Wellnitz&nbsp;|&nbsp;<a href=https://github.com/alexohneander/alexohneander-hugo/tree/main/content/posts/site-to-site-vpn-for-google-kubernetes-engine.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>In this tutorial I will try to explain you briefly and concisely how you can set up a site-to-site VPN for the Google Cloud Network.</p><h3 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h3><p>We need 2 virtual machines. The first one on the side of our office and the other one on the side of Google.</p><h4 id=setup-openvpn-clients>Setup OpenVPN Clients<a hidden class=anchor aria-hidden=true href=#setup-openvpn-clients>#</a></h4><h5 id=site-to-site-client-office-side>Site-to-Site Client Office Side<a hidden class=anchor aria-hidden=true href=#site-to-site-client-office-side>#</a></h5><p>We need to install OpenVPN, we do it as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt install openvpn -y
</span></span></code></pre></div><p>After that we add our OpenVPN configuration under this path <code>/etc/openvpn/s2s.conf</code>.</p><p><em>s2s.conf</em></p><pre tabindex=0><code># Use a dynamic tun device.
# For Linux 2.2 or non-Linux OSes,
# you may want to use an explicit
# unit number such as &#34;tun1&#34;.
# OpenVPN also supports virtual
# ethernet &#34;tap&#34; devices.
dev tun

# Our OpenVPN peer is the Google gateway.
remote IP_GOOGLE_VPN_CLIENT 

ifconfig 4.1.0.2 4.1.0.1

route 10.156.0.0 255.255.240.0            # Google Cloud VM Network
route 10.24.0.0 255.252.0.0               # Google Kubernetes Pod Network

push &#34;route 192.168.10.0 255.255.255.0&#34;   # Office Network 

# Our pre-shared static key
#secret static.key

# Cipher to use
cipher AES-256-CBC

port 1195

user nobody
group nogroup

# Uncomment this section for a more reliable detection when a system
# loses its connection.  For example, dial-ups or laptops that
# travel to other locations.
 ping 15
 ping-restart 45
 ping-timer-rem
 persist-tun
 persist-key

# Verbosity level.
# 0 -- quiet except for fatal errors.
# 1 -- mostly quiet, but display non-fatal network errors.
# 3 -- medium output, good for normal operation.
# 9 -- verbose, good for troubleshooting
verb 3

log /etc/openvpn/s2s.log
</code></pre><p>We also have to enable the IPv4 forward function in the kernel, so we go to <code>/etc/sysctl.conf</code> and comment out the following line:</p><pre tabindex=0><code>net.ipv4.ip_forward=1
</code></pre><p>We can then start our OpenVPN client with this command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start openvpn@s2s
</span></span></code></pre></div><p>On the Office side we have to open the port for the OpenVPN client that the other side can connect.</p><h5 id=site-to-site-client-google-side>Site-to-Site Client Google Side<a hidden class=anchor aria-hidden=true href=#site-to-site-client-google-side>#</a></h5><p>When setting up the OpenVPN client on Google&rsquo;s site, we need to consider the following settings when creating it. When we create the machine, we need to enable this option in the network settings:</p><p><img loading=lazy src=https://i.imgur.com/OXEkhxo.png alt="Google Cloud Network Settings"></p><p>Also on this side we have to install the OpenVPN client again and then add this config under the path <code>/etc/openvpn/s2s.conf</code>:</p><pre tabindex=0><code># Use a dynamic tun device.
# For Linux 2.2 or non-Linux OSes,
# you may want to use an explicit
# unit number such as &#34;tun1&#34;.
# OpenVPN also supports virtual
# ethernet &#34;tap&#34; devices.
dev tun

# Our OpenVPN peer is the Office gateway.
remote IP_OFFICE_VPN_CLIENT 

ifconfig 4.1.0.2 4.1.0.1

route 192.168.10.0 255.255.255.0          # Office Network

push &#34;route 10.156.0.0 255.255.240.0&#34;     # Google Cloud VM Network
push &#34;route 10.24.0.0 255.252.0.0&#34;        # Google Kubernetes Pod Network

# Our pre-shared static key
#secret static.key

# Cipher to use
cipher AES-256-CBC

port 1195

user nobody
group nogroup

# Uncomment this section for a more reliable detection when a system
# loses its connection.  For example, dial-ups or laptops that
# travel to other locations.
 ping 15
 ping-restart 45
 ping-timer-rem
 persist-tun
 persist-key

# Verbosity level.
# 0 -- quiet except for fatal errors.
# 1 -- mostly quiet, but display non-fatal network errors.
# 3 -- medium output, good for normal operation.
# 9 -- verbose, good for troubleshooting
verb 3

log /etc/openvpn/s2s.log
</code></pre><p>We also have to enable the IPv4 forward function in the kernel, so we go to <code>/etc/sysctl.conf</code> and comment out the following line:</p><pre tabindex=0><code>net.ipv4.ip_forward=1
</code></pre><h5 id=connection-test>Connection test<a hidden class=anchor aria-hidden=true href=#connection-test>#</a></h5><p>Now that both clients are basically configured we can test the connection. Both clients have to be started with systemctl. After that we look at the logs with <code>tail -f /etc/openvpn/s2s-log</code> and wait for this message:</p><pre tabindex=0><code>Wed May  5 08:28:01 2021 /sbin/ip route add 10.28.0.0/20 via 4.1.0.1
Wed May  5 08:28:01 2021 TCP/UDP: Preserving recently used remote address: [AF_INET]0.0.0.0:1195
Wed May  5 08:28:01 2021 Socket Buffers: R=[212992-&gt;212992] S=[212992-&gt;212992]
Wed May  5 08:28:01 2021 UDP link local (bound): [AF_INET][undef]:1195
Wed May  5 08:28:01 2021 UDP link remote: [AF_INET]0.0.0.0:1195
Wed May  5 08:28:01 2021 GID set to nogroup
Wed May  5 08:28:01 2021 UID set to nobody
Wed May  5 08:28:11 2021 Peer Connection Initiated with [AF_INET]0.0.0.0:1195
Wed May  5 08:28:12 2021 WARNING: this configuration may cache passwords in memory -- use the auth-nocache option to prevent this
Wed May  5 08:28:12 2021 Initialization Sequence Completed
</code></pre><p>If we can&rsquo;t establish a connection, we need to check if the ports are opened on both sides.</p><h4 id=routing-google-cloud-network>Routing Google Cloud Network<a hidden class=anchor aria-hidden=true href=#routing-google-cloud-network>#</a></h4><p>After our clients have finished installing and configuring, we need to set the routes on Google. I will not map the Office side, as this is always different. But you have to route the networks for the Google network there as well.</p><p>To set the route on Google we go to the network settings and then to Routes. Here you have to specify your office network so that the clients in the Google network know what to do.</p><p><img loading=lazy src=https://i.imgur.com/6Q2Drf4.png alt="Google Cloud Network Route"></p><h4 id=ip-masquerade-agent>IP-Masquerade-Agent<a hidden class=anchor aria-hidden=true href=#ip-masquerade-agent>#</a></h4><p>IP masquerading is a form of network address translation (NAT) used to perform many-to-one IP address translations, which allows multiple clients to access a destination using a single IP address. A GKE cluster uses IP masquerading so that destinations outside of the cluster only receive packets from node IP addresses instead of Pod IP addresses. This is useful in environments that expect to only receive packets from node IP addresses.</p><p>You have to edit the ip-masq-agent and this configuration is responsible for letting the pods inside the nodes, reach other parts of the GCP VPC Network, more specifically the VPN. So, it allows pods to communicate with the devices that are accessible through the VPN.</p><p>First of all we&rsquo;re gonna be working inside the kube-system namespace, and we&rsquo;re gonna put the configmap that configures our ip-masq-agent, put this in a config file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>nonMasqueradeCIDRs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>10.24.0.0</span><span style=color:#ae81ff>/14 </span> <span style=color:#75715e># The IPv4 CIDR the cluster is using for Pods (required)</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>10.156.0.0</span><span style=color:#ae81ff>/20</span> <span style=color:#75715e># The IPv4 CIDR of the subnetwork the cluster is using for Nodes (optional, works without but I guess its better with it)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>masqLinkLocal</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>resyncInterval</span>: <span style=color:#ae81ff>60s</span>
</span></span></code></pre></div><p>and run <code>kubectl create configmap ip-masq-agent --from-file config --namespace kube-system</code></p><p>afterwards, configure the ip-masq-agent, put this in a <code>ip-masq-agent.yml</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>extensions/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>DaemonSet</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ip-masq-agent</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>kube-system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>k8s-app</span>: <span style=color:#ae81ff>ip-masq-agent</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>hostNetwork</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ip-masq-agent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gcr.io/google-containers/ip-masq-agent-amd64:v2.4.1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>masq-chain=IP-MASQ</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># To non-masquerade reserved IP ranges by default, uncomment the line below.</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># - --nomasq-all-reserved-ranges</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>privileged</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/etc/config</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>configMap</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># Note this ConfigMap must be created in the same namespace as the daemon pods - this spec uses kube-system</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ip-masq-agent</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>optional</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>items</span>:
</span></span><span style=display:flex><span>              <span style=color:#75715e># The daemon looks for its config in a YAML file at /etc/config/ip-masq-agent</span>
</span></span><span style=display:flex><span>              - <span style=color:#f92672>key</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>path</span>: <span style=color:#ae81ff>ip-masq-agent</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>tolerations</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>effect</span>: <span style=color:#ae81ff>NoSchedule</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>operator</span>: <span style=color:#ae81ff>Exists</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>effect</span>: <span style=color:#ae81ff>NoExecute</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>operator</span>: <span style=color:#ae81ff>Exists</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;CriticalAddonsOnly&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>operator</span>: <span style=color:#e6db74>&#34;Exists&#34;</span>
</span></span></code></pre></div><p>and run <code>kubectl -n kube-system apply -f ip-masq-agent.yml</code>.</p><p>Now our site-to-site VPN should be set up. You should now test if you can ping the pods and if all other services work as you expect them to.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://alexohneander.de/tags/kubernetes/>kubernetes</a></li><li><a href=https://alexohneander.de/tags/openvpn/>openvpn</a></li><li><a href=https://alexohneander.de/tags/google/>google</a></li></ul><nav class=paginav><a class=prev href=https://alexohneander.de/posts/baremetal-cni-setup-with-cilium/><span class=title>« Prev Page</span><br><span>Baremetal CNI Setup with Cilium</span></a>
<a class=next href=https://alexohneander.de/posts/backup-mysql-databases-in-kubernetes/><span class=title>Next Page »</span><br><span>Backup MySQL Databases in Kubernetes</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Site to Site VPN for Google Kubernetes Engine on twitter" href="https://twitter.com/intent/tweet/?text=Site%20to%20Site%20VPN%20for%20Google%20Kubernetes%20Engine&url=https%3a%2f%2falexohneander.de%2fposts%2fsite-to-site-vpn-for-google-kubernetes-engine%2f&hashtags=kubernetes%2copenvpn%2cgoogle"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Site to Site VPN for Google Kubernetes Engine on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2falexohneander.de%2fposts%2fsite-to-site-vpn-for-google-kubernetes-engine%2f&title=Site%20to%20Site%20VPN%20for%20Google%20Kubernetes%20Engine&summary=Site%20to%20Site%20VPN%20for%20Google%20Kubernetes%20Engine&source=https%3a%2f%2falexohneander.de%2fposts%2fsite-to-site-vpn-for-google-kubernetes-engine%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Site to Site VPN for Google Kubernetes Engine on reddit" href="https://reddit.com/submit?url=https%3a%2f%2falexohneander.de%2fposts%2fsite-to-site-vpn-for-google-kubernetes-engine%2f&title=Site%20to%20Site%20VPN%20for%20Google%20Kubernetes%20Engine"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Site to Site VPN for Google Kubernetes Engine on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2falexohneander.de%2fposts%2fsite-to-site-vpn-for-google-kubernetes-engine%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Site to Site VPN for Google Kubernetes Engine on whatsapp" href="https://api.whatsapp.com/send?text=Site%20to%20Site%20VPN%20for%20Google%20Kubernetes%20Engine%20-%20https%3a%2f%2falexohneander.de%2fposts%2fsite-to-site-vpn-for-google-kubernetes-engine%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Site to Site VPN for Google Kubernetes Engine on telegram" href="https://telegram.me/share/url?text=Site%20to%20Site%20VPN%20for%20Google%20Kubernetes%20Engine&url=https%3a%2f%2falexohneander.de%2fposts%2fsite-to-site-vpn-for-google-kubernetes-engine%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://alexohneander.de>Alexohneander</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>